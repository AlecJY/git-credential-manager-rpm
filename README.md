# Git Credential Manager RPM
[![build result](https://build.opensuse.org/projects/home:AlecJY:gcm/packages/git-credential-manager/badge.svg?type=default)](https://build.opensuse.org/package/show/home:AlecJY:gcm/git-credential-manager)

---

## Install
There are prebuilt RPMs for the following distributions
* CentOS 8
* Fedora 41
* Fedora 42
* SLES 15 SP6 / openSUSE 15.6
* SLES 15 SP7
* SLES 16.0 / openSUSE 16.0
* openSUSE Slowroll
* openSUSE Tumbleweed

Follow the [instruction](https://software.opensuse.org//download.html?project=home%3AAlecJY%3Agcm&package=git-credential-manager) to install

## Patches
There are several patches appied to the original source code

| Name                        | Source                                                                                                                                      | Arch    | Description                                           |
|-----------------------------|---------------------------------------------------------------------------------------------------------------------------------------------|---------|-------------------------------------------------------|
| `linux-only.patch`          | [AlecJY/git-credential-manager@`446e4eb`](https://github.com/AlecJY/git-credential-manager/commit/446e4eb697eb7ac5f7d5630d57403dd18fda42aa) | all     | Add `linux-arm64` runtime identifier to support aarch64 and remove other non-Linux identifiers to prevent downloading dependencies of other platforms |
| `runtime-arm64.patch`       | [AlecJY/git-credential-manager@`b2065a7`](https://github.com/AlecJY/git-credential-manager/commit/b2065a716b45566721c26f01f8d02e168d8aa052) | aarch64 | Patch the Linux build script to set dotnet runtime to `linux-arm64` |
| `install-buildoutput.patch` | [AlecJY/git-credential-manager@`e256ea3`](https://github.com/AlecJY/git-credential-manager/commit/e256ea3a2c6a6ff52db976a5a92ab701a5a6eed0) | all     | Patch the Linux build script to install Git Credential Manager into "buildoutput" directory instead of generating deb and tar packages |

## Build
There are to variants of the RPM SPEC file, the normal one requires Internet access and the one especially for openSUSE Build Service or other environments without Internet access.

### Build with Internet access

#### Install the build dependencies
```bash
# For RHEL / CentOS / Fedora / etc...
$ sudo yum install -y rpm-build dotnet-sdk-8.0 openssl-libs libicu
# For SLES / openSUSE / etc...
# Run the first command only if you didn't install dotnet SDK
$ sudo zypper addrepo https://packages.microsoft.com/config/opensuse/15/prod.repo
$ sudo zypper refresh
$ sudo zypper install -y rpm-build dotnet-sdk-8.0 libopenssl1_1 libicu
```

#### Build the RPM
```bash
$ git clone https://github.com/AlecJY/git-credential-manager-rpm.git
$ cd git-credential-manager-rpm
$ rpmbuild -bb git-credential-manager.spec --undefine "_disable_source_fetch" --define "_sourcedir $PWD"
```

### Build without Internet access
#### Prepare the following files on a machine with Internet access
##### This repo (branch `obs`)
Download from https://github.com/AlecJY/git-credential-manager-rpm/archive/refs/heads/obs.tar.gz

##### Git Credential Manager source code
Download from https://github.com/GitCredentialManager/git-credential-manager/archive/refs/tags/v${version}.tar.gz

Replace ${version} with the latest version of Git Credential Manager. For example: 
https://github.com/GitCredentialManager/git-credential-manager/archive/refs/tags/v2.2.0.tar.gz

##### Prebuilt dotnet SDK 8.0 binaries
You can download from https://dotnet.microsoft.com/en-us/download/dotnet/8.0

Download both `arm64` and `x64` binaries for Linux even if you only want to build on one architecture.

> The reason that you need to download dotnet SDK for both platforms is to make sure all architectures share the same source RPM.

> If you really don't want to download dotnet SDK for the other architecture, you can just create an empty file with the name.

##### Pre-downloaded NuGet dependencies
**Recommend to do this step in a clean docker container to prevent other unnecessary NuGet packages being included**

Build Git Credential Manager on a machine with Internet access once (such as follow the steps in [Build with Internet access](#build-with-internet-access) section). Then compress the packages directory generated by Nuget
```bash
$ cd ~/.nuget/
$ tar Jcvf nuget-packages.tar.xz packages/
```

> Some packages are platform-specific such as `Microsoft.NETCore.App.Host.xxx`. Therefore, to make a cross-platform offline NuGet packages archive you need to run this step on each platform then combine the data in the archives together.

#### Install the build dependencies
```bash
# For RHEL / CentOS / Fedora / etc...
$ sudo yum install -y rpm-build openssl-libs libicu
# For SLES / openSUSE / etc...
$ sudo zypper install -y rpm-build libopenssl1_1 libicu
```

#### Build the RPM
Now you should have four files
* obs.tar.gz
* The compressed GCM source code. Ex: v2.1.0.tar.gz
* dotnet-sdk-8.0.xxx-linux-arm64.tar.gz
* dotnet-sdk-8.0.xxx-linux-x64.tar.gz
* nuget-packages.tar.xz

Extract `obs.tar.gz` and put other four files into the extracted `git-credential-manager-rpm-obs` directory.

Then open `git-credential-manager.spec` with a text editor. Check the two lines
```specfile
...
%global dotnet_version    8.0.xxx
...
Version:        2.x.x
...
```
`dotnet_version` is the version of dotnet SDK, and `Version` is the version of Git Credential Manager.

If the version differ from the files you downloaded, correct the version numbers and save.

The last step is running the following command
```bash
$ rpmbuild -bb git-credential-manager.spec --define "_sourcedir $PWD"
```

## Known issues
* dotnet will produce some data outside the build directory
* Require some prebuilt binaries
